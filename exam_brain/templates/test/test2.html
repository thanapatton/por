{% load static %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <title>Speech to Text with No Speech Duration</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .time {
      font-weight: bold;
      color: green;
    }
    .no-speech {
      color: red;
      font-weight: bold;
    }
    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
    }
  </style>
</head>
<body>

  <h1>Speech to Text with "No Speech" Duration</h1>
  <div class="container d-flex justify-content-center align-items-center" style="height: 100vh">
    <div class="text-center">
        <div id="start">
            <button id="start_read" type="button" class="btn btn-primary" onclick="testExam4()">คลิกเพื่อเริ่มทดสอบ</button>
        </div>
        <div id="board">
            <div class="row">
                <h1 id="current-value-questions"></h1>
                {% comment %} <img style="display: none" id= "currentImage" src="{% static data.images.0 %}" />  {% endcomment %}  
            </div>
               
            <div class="row">
                <img  class ="center"style="display: none max-height: 500px; max-width:500px;" id= "dynamicImage" /> 
            </div>
            <div>
                <button id="next_read" type="button" class="btn btn-primary" style="display: none" onclick="showNextValue()">ต่อไป</button>
              </div>

        </div>
        <div id="recordResult" style="display: none">
            <button id="start-btn">Start Speech Recognition</button>
            <button id="stop-btn" disabled>Stop</button>
            
            <p><strong>Recognized Text:</strong></p>
            <p id="result-text">Press the start button and speak...</p>
            
            <p><strong>Total Recording Time:</strong> <span id="record-time" class="time">0s</span></p>
            <p><strong>No Speech Duration:</strong> <span id="no-speech-time" class="no-speech">0s</span></p>
            <p id="noSpeechCount">No Speech Count: <span id="count">0</span></p>
            <p id="noSpeechCountSum">No Speech Count Sum: <span id="countSum">0</span></p>
            <p id="responseText"></p>
        </div>
    </div>
  </div>  

  <script>
    var currentIndex = 0;
    var images = {{ data.images|safe }} ;
    var awnser = {{ data.awnser|safe }} ;
    var baseStaticUrl = "{% static '' %}";
    var wordRegResult = '';
    let isSave = false;
    let messageResult = ''
    var keepChoice = [];
    let countNoSpech = 0; 

    function testExam4() {
        $("#start_read").hide();
        $("#recordResult").show();
        showNextValue() 
    }

    async function showNextValue() {
        if(isSave){
          keepChice(currentIndex,messageResult,wordRegResult,countNoSpech)
        }
        startTime = performance.now();  
        $("#next_read").hide();
        {% comment %} recognition.start(); {% endcomment %}
        
          if (currentIndex < images.length) {
            imageName = images[currentIndex];
            var imageUrl = baseStaticUrl + imageName;
            document.getElementById('dynamicImage').src = imageUrl;
            $("#current-value-questions").text("ข้อ "+[currentIndex+1])
            await delay(500);
            $("#current-value-questions").text("ตอบคำถามด้วยการพูด แล้ว กดปุ่มด้ามล่างเพื่อทำข้อต่อไป")
            $("#dynamicImage").show()
          }
      }
      
      function delay(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
      }
  
  
      // ---------------------------------------------------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      alert("Your browser does not support Speech Recognition API.");
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = 'th-TH'; 
      recognition.interimResults = false; 
      recognition.maxAlternatives = 1; 
      recognition.continuous = true;  // Keep listening even after a pause

      let startTime, silenceStartTime;
      let silenceDuration = 0;
      let recognitionTimeout, silenceTimeout;

      let noSpeechDuration = 0; // Duration in milliseconds

      let recognizing = false;
      const checkInterval = 100; // Check every 100ms
      let noSpeechCounter = 0;
      let sumNoSpeechCount = 0;

      const startBtn = document.getElementById('start-btn');
      const stopBtn = document.getElementById('stop-btn');
      const resultText = document.getElementById('result-text');
      const recordTime = document.getElementById('record-time');
      const noSpeechTime = document.getElementById('no-speech-time');
      const noSpeechTimeMs = document.getElementById('no-speech-time-ms');
      const countDisplay = document.getElementById('count');
      const countSumDisplay = document.getElementById('countSum');

      // Update total recording time in seconds and milliseconds
      function updateTimer() {
        if (startTime) {
          const now = new Date().getTime();
          const elapsedTime = now - startTime;  // Time in milliseconds

          // Convert to seconds and milliseconds
          const seconds = Math.floor(elapsedTime / 1000); // Whole seconds
          const milliseconds = elapsedTime % 1000;        // Remaining milliseconds

          // Display formatted time
          recordTime.textContent = `${seconds}s ${milliseconds}ms`;
        }
      }

      // Update "no speech" duration in milliseconds
      function updateNoSpeechTimer() {
        let countDuration = 0 ;
        if (silenceStartTime) {
          const now = new Date().getTime();
          silenceDuration = now - silenceStartTime; // Silence duration in milliseconds
          countDuration =  silenceDuration
          if(countDuration > 2000){
            countDuration = 0;
            countNoSpech += 1;
          }
          
          noSpeechTime.textContent = `${silenceDuration}ms`;
        }
      }

      
      function keepChice(index,text,wordReg,sumNoSpeech){
        let jsonResult = {
          message: text,
          wordReg: wordReg,
          sumNoSpeech: sumNoSpeech
        }
        keepChoice[currentIndex] = JSON.stringify(jsonResult)
        console.log(keepChoice)
        messageResult = '' 
        wordRegResult = ''
        countNoSpech = 0
        currentIndex++;
      }

      // Start speech recognition
      startBtn.addEventListener('click', () => {
        console.log("xxxxx")
        if (!recognizing) {
          recognition.start(); // Start the recognition
          recognizing = true;
          console.log("Recognition started");
        }
        startBtn.disabled = true;
        stopBtn.disabled = false;
        resultText.textContent = "Listening...";
        
        // Reset timers
        silenceDuration = 0;
        noSpeechTime.textContent = "0ms";
        startTime = new Date().getTime();
        recordTime.textContent = "0s"; 
        silenceStartTime = new Date().getTime();

        // Start updating timers
        silenceTimeout = setInterval(updateNoSpeechTimer, 100);   // Update "no speech" duration every 100 ms
        recognitionTimeout = setInterval(updateTimer, 100);       // Update total time every 100 ms
      });

      // Stop speech recognition
      stopBtn.addEventListener('click', () => {
        recognition.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;

        // Stop timers
        clearInterval(recognitionTimeout);
        clearInterval(silenceTimeout);
      });

      // Monitor for no speech duration
      setInterval(() => {
        if (recognizing) {
            noSpeechDuration += checkInterval;

            if (noSpeechDuration > 2000) {
                noSpeechCounter += 1;
                countDisplay.innerHTML = noSpeechCounter; // Update the display
                noSpeechDuration = 0; // Reset the duration counter
            }
        }
      }, checkInterval);


      // Handle speech recognition result
      recognition.addEventListener('result', (event) => {
        if(noSpeechCounter > 0 ){
          console.log("gggggg")
          sumNoSpeechCount +=1 ;
          countSumDisplay.innerHTML = sumNoSpeechCount;
        }
        const transcript = event.results[event.results.length - 1][0].transcript;
        messageResult += transcript;
        resultText.textContent = messageResult;
        word_tokenize_api(messageResult);

        // Reset silence duration when speech is detected
        silenceStartTime = new Date().getTime();
        silenceDuration = 0;
        noSpeechTime.textContent = "0ms";
        noSpeechCounter = 0; // Reset counter on speech
        noSpeechDuration = 0; // Reset duration on speech
        isSave = true;
        $("#next_read").show();
        
      });

      // Handle recognition end (keep listening)
      recognition.addEventListener('end', () => {
        if (!stopBtn.disabled) {
          recognition.start();  // Restart recognition if not manually stopped
        }
      });

      // Handle recognition errors
      recognition.addEventListener('error', (event) => {
        console.error('Speech recognition error: ' + event.error);
        resultText.textContent = "Error: " + event.error;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        clearInterval(recognitionTimeout);
        clearInterval(silenceTimeout);
      });

      function word_tokenize_api(userInput){
         // Sending data to Django using fetch
         fetch('/exam/word-tokenize/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken':  getCookie('csrftoken')  // Django CSRF token for security
          },
          body: JSON.stringify({
              data: userInput
          })
         })
        .then(response => response.json())
        .then(data => {
            wordRegResult +=  data.message;
            document.getElementById('responseText').innerText =  wordRegResult;
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      }
    }


    // Get CSRF token from the cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Check if this cookie string begins with the name we want
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }
  </script>
</body>
</html>
